<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ana MenÃ¼</title>
  <link rel="stylesheet" href="styles/style.css" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

  <div class="top-bar">
    <div class="welcome-text" id="welcome-message">HoÅŸ geldin!</div>
    <div class="profile-section">
      <div class="profile-button" onclick="toggleProfile()">
        <img src="images/default-avatar.png" id="mini-profile" class="profile-img-small" />
        <span id="mini-name">Profil</span>
      </div>
      <button onclick="logout()" class="logout-button">Ã‡Ä±kÄ±ÅŸ</button>
      <div id="profile-box">
        <form id="profile-form">
          <!-- Profil FotoÄŸrafÄ± YÃ¼kleme BÃ¶lÃ¼mÃ¼ -->
          <div class="photo-upload-section">
            <div class="current-photo">
              <img id="profile-preview" src="images/default-avatar.png" class="profile-photo-large" />
            </div>
            <input type="file" id="photo-input" accept="image/*" style="display: none;" />
            <button type="button" onclick="document.getElementById('photo-input').click()" class="photo-upload-btn">
              ðŸ“¸ FotoÄŸraf SeÃ§
            </button>
          </div>
          
          <input type="text" id="ad" placeholder="Ad" />
          <input type="text" id="soyad" placeholder="Soyad" />
          <input type="text" id="uni" placeholder="Ãœniversite-BÃ¶lÃ¼m" />
          <textarea id="hobiler" placeholder="Hobiler"></textarea>
          <button type="submit">Kaydet</button>
        </form>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="menu-buttons">
      <button onclick="window.location.href='kimdir.html'" class="menu-button">Sualp Kula</button>
      <button onclick="window.location.href='ders-notlari.html'" class="menu-button">Ders NotlarÄ±</button>
      <button onclick="window.location.href='surpriz.html'" class="menu-button">SÃ¼rpriz</button>
      <button onclick="checkAdminAndRedirect()" class="menu-button" id="admin-button" style="background-color: #667eea; color: white; display: none;">ðŸ”§ Admin Panel</button>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://bvlyzxljieftbkzkdwzv.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2bHl6eGxqaWVmdGJremtkd3p2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4ODQxNTgsImV4cCI6MjA2NjQ2MDE1OH0.mJEavNb2WC_0pBpg8KJq0ABc2hquYTewoge38U5P7dw";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Admin Email Listesi - admin.html ile aynÄ±
    const ADMIN_EMAILS = [
      "sualpkula@gmail.com",
      "sualpkula81@gmail.com"
    ];

    let currentUser = null;

    // Profil fotoÄŸrafÄ± Ã¶nizleme
    document.getElementById('photo-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profile-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Profil bilgilerini yÃ¼kle
    async function loadProfile() {
      const { data: { user }, error: userError } = await supabase.auth.getUser();
      if (userError || !user) {
        console.warn("KullanÄ±cÄ± bulunamadÄ±:", userError?.message);
        return;
      }

      currentUser = user;

      // Admin butonu kontrolÃ¼
      if (ADMIN_EMAILS.includes(user.email)) {
        document.getElementById("admin-button").style.display = "block";
      }

      // Profil bilgilerini getir - ID olarak email kullan
      const { data, error } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user.email)  // Email'i ID olarak kullan
        .single();

      if (error) {
        console.warn("Profil yÃ¼klenemedi:", error.message);
        // Ä°lk kez giriÅŸ yapan kullanÄ±cÄ± iÃ§in varsayÄ±lan deÄŸerler
        document.getElementById("welcome-message").textContent = `HoÅŸ geldin, ${user.email}!`;
        document.getElementById("mini-name").textContent = "Profil";
        return;
      }

      if (data) {
        document.getElementById("ad").value = data.ad || "";
        document.getElementById("soyad").value = data.soyad || "";
        document.getElementById("uni").value = data.uni || "";
        document.getElementById("hobiler").value = data.hobiler || "";
        
        // Profil fotoÄŸrafÄ±nÄ± yÃ¼kle
        if (data.profile_photo) {
          document.getElementById("mini-profile").src = data.profile_photo;
          document.getElementById("profile-preview").src = data.profile_photo;
        }
        
        const displayName = data.ad || user.email.split('@')[0];
        document.getElementById("welcome-message").textContent = `HoÅŸ geldin, ${displayName}!`;
        document.getElementById("mini-name").textContent = data.ad || "Profil";
      }
    }

    // Profil formu submit
    document.getElementById("profile-form").addEventListener("submit", async function (e) {
      e.preventDefault();

      if (!currentUser) {
        alert("GiriÅŸ yapÄ±lmadÄ±!");
        return;
      }

      const ad = document.getElementById("ad").value.trim();
      const soyad = document.getElementById("soyad").value.trim();
      const uni = document.getElementById("uni").value.trim();
      const hobiler = document.getElementById("hobiler").value.trim();
      const photoInput = document.getElementById("photo-input");

      // Buton loading state
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = "Kaydediliyor...";
      submitBtn.disabled = true;

      try {
        let profilePhotoUrl = null;

        // EÄŸer yeni fotoÄŸraf seÃ§ildiyse
        if (photoInput.files[0]) {
          const file = photoInput.files[0];
          const fileName = `profile_${currentUser.email}_${Date.now()}.${file.name.split('.').pop()}`;
          
          // Supabase Storage'a yÃ¼kle
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('profile-photos')
            .upload(fileName, file);

          if (uploadError) {
            throw new Error("FotoÄŸraf yÃ¼klenemedi: " + uploadError.message);
          }

          // Public URL al
          const { data: urlData } = supabase.storage
            .from('profile-photos')
            .getPublicUrl(fileName);

          profilePhotoUrl = urlData.publicUrl;
        }

        // Database'e kaydet
        const profileData = {
          id: currentUser.email,  // Email'i ID olarak kullan
          ad,
          soyad,
          uni,
          hobiler
        };

        // EÄŸer yeni fotoÄŸraf varsa ekle
        if (profilePhotoUrl) {
          profileData.profile_photo = profilePhotoUrl;
        }

        const { error } = await supabase
          .from("profiles")
          .upsert(profileData);

        if (error) {
          throw error;
        }

        alert("Profil baÅŸarÄ±yla kaydedildi!");
        
        const displayName = ad || currentUser.email.split('@')[0];
        document.getElementById("welcome-message").textContent = `HoÅŸ geldin, ${displayName}!`;
        document.getElementById("mini-name").textContent = ad || "Profil";
        
        // EÄŸer yeni fotoÄŸraf kaydedildiyse mini profile'Ä± gÃ¼ncelle
        if (profilePhotoUrl) {
          document.getElementById("mini-profile").src = profilePhotoUrl;
        }
        
        toggleProfile();

      } catch (error) {
        console.error("Profil kaydetme hatasÄ±:", error);
        alert("Profil kaydedilemedi: " + error.message);
      } finally {
        // Buton state'ini geri al
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // Profil kutusunu aÃ§/kapat
    function toggleProfile() {
      const box = document.getElementById("profile-box");
      box.style.display = box.style.display === "none" || box.style.display === "" ? "block" : "none";
    }

    // Admin panel eriÅŸim kontrolÃ¼
    async function checkAdminAndRedirect() {
      if (currentUser && ADMIN_EMAILS.includes(currentUser.email)) {
        window.location.href = 'admin.html';
      } else {
        alert("Admin paneline eriÅŸim yetkiniz yok.");
      }
    }

    // Ã‡Ä±kÄ±ÅŸ fonksiyonu
    async function logout() {
      const confirmLogout = confirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?");
      
      if (!confirmLogout) return;
      
      try {
        // Supabase'den Ã§Ä±kÄ±ÅŸ yap
        const { error } = await supabase.auth.signOut();
        
        if (error) {
          console.error("Logout hatasÄ±:", error.message);
          alert("Ã‡Ä±kÄ±ÅŸ yapÄ±lÄ±rken hata oluÅŸtu: " + error.message);
          return;
        }
        
        // Session storage'Ä± temizle
        sessionStorage.clear();
        localStorage.clear();
        
        alert("BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yaptÄ±nÄ±z!");
        
        // GiriÅŸ sayfasÄ±na yÃ¶nlendir
        window.location.href = "index.html";
        
      } catch (err) {
        console.error("Beklenmeyen logout hatasÄ±:", err);
        alert("Beklenmeyen bir hata oluÅŸtu. Sayfa yenilenecek.");
        window.location.reload();
      }
    }

    // Session kontrolÃ¼
    async function checkSession() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        
        if (error) {
          console.error("Session kontrol hatasÄ±:", error);
          return false;
        }
        
        if (!user) {
          alert("Oturum sÃ¼resi dolmuÅŸ. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
          window.location.href = "index.html";
          return false;
        }
        
        return true;
      } catch (err) {
        console.error("Session kontrol kritik hatasÄ±:", err);
        alert("Bir hata oluÅŸtu. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
        window.location.href = "index.html";
        return false;
      }
    }

    // Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak fonksiyon
    window.onload = async function() {
      const sessionValid = await checkSession();
      if (sessionValid) {
        await loadProfile();
      }
    };

    // Profile kutusunu kapatmak iÃ§in dÄ±ÅŸarÄ± tÄ±klanÄ±nca
    document.addEventListener('click', function(event) {
      const profileBox = document.getElementById('profile-box');
      const profileButton = document.querySelector('.profile-button');
      
      if (!profileButton.contains(event.target) && !profileBox.contains(event.target)) {
        profileBox.style.display = 'none';
      }
    });
  </script>


</body>
</html>



